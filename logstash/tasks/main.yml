- name: establish logstash
  package:
    name: logstash
    state: present
  tags: install

- name: establish logstash plugins
  become: yes
  logstash_plugin:
    name:  "{{ item }}"
    state: present
  with_items: "{{ plugins }}"
  notify: restart logstash
  tags: install

- name: configure logstash port
  template:
    src: pipeline.conf.j2
    dest: "{{ logstash.config_path }}/{{ configuration.name | regex_replace('[^0-9a-zA-Z_]+', '_') }}.conf"
    mode: "u=rw,go=r"
  loop_control:
    loop_var: configuration
  with_items: "{{ pipeline_configuration }}"
  notify: restart logstash
  tags: configure

- name: initiate configured pipelines
  systemd:
    name: logstash
    enabled: yes
    state: started
  tags: configure

